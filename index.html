<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>AI Crime Scene â€” v18 GoldMetaXR RealMotion</title>

<!-- A-Frame -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

<style>
:root{--gold:#d4af37;--gold2:#b78f2a;--dark:#0b0f13;--glass:#0b0f13cc}
*{box-sizing:border-box}
html,body{margin:0;height:100%;overflow:hidden;background:var(--dark);color:#fff;font-family:"Tajawal",system-ui,Arial}

/* Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ ÙˆØ§Ù„Ø·Ø¨Ù‚Ø§Øª */
#root {width:100vw;height:100vh;position:relative}
#scene{width:100%;height:100%}

/* AR-Lite: ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ù„ÙÙŠØ© */
#arVideoBg{
  position:fixed;inset:0;object-fit:cover;width:100vw;height:100vh;
  z-index:0;display:none;background:#000
}

/* HUD */
#hud{
  position:fixed;top:10px;left:50%;transform:translateX(-50%);
  z-index:8000;display:flex;gap:10px;align-items:center;
  background:rgba(0,0,0,.55);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.12);
  padding:6px 12px;border-radius:10px;font-weight:800
}
#time{color:#ffd966} #status{color:#cfe1ff} #score{color:#39d98a}

/* Ø´Ø§Ø´Ø© Ø§Ø¨Ø¯Ø£ + Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¶Ø¹ */
#gate{
  position:fixed;inset:0;z-index:9000;display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:radial-gradient(720px 460px at 50% 40%,rgba(212,175,55,.14),rgba(0,0,0,.86));
  text-align:center;padding:16px;color:var(--gold)
}
#btnStart{
  border:none;border-radius:14px;padding:12px 28px;cursor:pointer;color:#000;font-weight:900;font-size:18px;
  background:linear-gradient(90deg,var(--gold),var(--gold2));box-shadow:0 0 16px rgba(212,175,55,.55);
}
#chooser{display:none;gap:14px;margin-top:14px;flex-wrap:wrap;justify-content:center}
.cardMode{
  position:relative;overflow:hidden;border-radius:18px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);
  min-width:240px;padding:14px;cursor:pointer;transition:transform .18s ease, box-shadow .18s ease;
  box-shadow:inset 0 0 16px rgba(212,175,55,.12)
}
.cardMode:hover{transform:translateY(-3px);box-shadow:0 10px 28px rgba(212,175,55,.25)}
.cardMode h3{margin:0 0 6px;color:var(--gold)}
.cardMode p{margin:0;color:#dfe7ff;opacity:.9;font-size:14px}
.badge{position:absolute;top:10px;left:10px;background:linear-gradient(90deg,var(--gold),var(--gold2));color:#000;font-weight:900;padding:6px 10px;border-radius:999px;font-size:12px}

/* ØªÙØ¹ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„Ø¬ÙˆØ§Ù„ */
#motionTip{
  position:fixed;top:70px;left:50%;transform:translateX(-50%);
  z-index:8050;background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:10px;display:none
}
#btnMotion{border:none;border-radius:10px;padding:6px 10px;cursor:pointer;font-weight:800;
  background:linear-gradient(90deg,var(--gold),var(--gold2));color:#000}

/* Ø·Ø¨Ù‚Ø© ÙˆØ§Ø¬Ù‡Ø© (ÙƒÙ…Ø§Ù‡ÙŠ) */
#uiLayer{position:fixed;inset:0;z-index:7000;pointer-events:none}
#btnOpen{
  position:absolute;top:20px;right:20px;width:56px;height:56px;border:none;border-radius:50%;
  background:radial-gradient(circle at 35% 30%,var(--gold),var(--gold2));color:#000;font-weight:900;font-size:22px;
  box-shadow:0 0 12px rgba(212,175,55,.6);pointer-events:auto;cursor:pointer
}
#sidebar{
  position:absolute;top:0;right:0;width:380px;height:100%;background:var(--glass);backdrop-filter:blur(12px);
  border-left:1px solid rgba(255,255,255,.12);padding:12px;overflow:auto;transition:right .35s ease;pointer-events:auto
}
#sidebar.hidden{right:-400px}
#sidebar h2{color:var(--gold);margin:10px 0 6px}
.btn{border:none;border-radius:10px;padding:7px 10px;cursor:pointer;font-weight:800;background:linear-gradient(90deg,var(--gold),var(--gold2));color:#000}
.btn-ghost{border:1px solid rgba(255,255,255,.2);background:transparent;color:#e0e6f2;border-radius:10px;padding:7px 10px;cursor:pointer}
input,select{width:100%;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0c1116;color:#fff}
.library{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px}
.card{background:rgba(255,255,255,.06);border-radius:12px;padding:8px;text-align:center;box-shadow:inset 0 0 12px rgba(212,175,55,.12)}
.card .btn{width:100%;margin-top:6px}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… (ÙƒÙ…Ø§Ù‡ÙŠ) */
.dynamic-controls,.camera-controls{
  position:fixed;bottom:18px;background:rgba(0,0,0,.6);border-radius:12px;padding:10px;display:flex;gap:6px;z-index:6500
}
.dynamic-controls{left:18px;flex-direction:column}
.camera-controls{left:50%;transform:translateX(-50%)}
.ctrl-btn,.cam-btn{
  width:44px;height:44px;border:none;border-radius:10px;background:var(--gold);color:#000;font-weight:900;cursor:pointer;box-shadow:0 0 8px rgba(212,175,55,.45)
}

/* Ù…Ù„Ø§Ø­Ø¸Ø§Øª + Toast */
#noteModal{position:fixed;inset:0;display:none;place-items:center;z-index:9500;background:radial-gradient(520px 300px at 50% 40%,rgba(212,175,55,.12),rgba(0,0,0,.65))}
.noteCard{width:min(92vw,520px);background:#0b0f13ee;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;box-shadow:0 0 20px rgba(212,175,55,.35)}
.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);padding:10px 14px;border-radius:10px;display:none;z-index:8500}

/* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
#loader{
  position:fixed;inset:0;display:none;place-items:center;z-index:9100;background:rgba(0,0,0,.35)
}
.spinner{width:60px;height:60px;border-radius:50%;border:5px solid rgba(212,175,55,.25);border-top-color:var(--gold);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* D-ID */
#didWrap{position:fixed;z-index:12000;right:14px;bottom:14px;width:min(360px,42vw);max-width:90vw}

/* Ù…ÙˆØ¨Ø§ÙŠÙ„ */
@media (max-width:768px){
  .dynamic-controls,.camera-controls{left:50%;transform:translateX(-50%);background:rgba(10,14,18,.85);gap:8px}
  .dynamic-controls{bottom:96px;flex-direction:row;flex-wrap:wrap;justify-content:center;width:92vw}
  .camera-controls{bottom:16px;flex-wrap:wrap;width:92vw;justify-content:center}
}
</style>
</head>
<body>
<div id="root">
  <video id="arVideoBg" autoplay playsinline muted></video>

  <!-- HUD -->
  <div id="hud">â± <span id="time">--:--</span> | <span id="status">Ø¬Ø§Ù‡Ø²</span> | ğŸ§® <span id="score">0</span></div>
  <div id="motionTip">Ù„ØªÙØ¹ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„Ø¬ÙˆØ§Ù„ <button id="btnMotion">Ø§Ø¶ØºØ· Ù‡Ù†Ø§</button></div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ø¨Ø¯Ø£ -->
  <div id="gate">
    <h1 style="font-size:22px;margin:0 0 10px">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨ÙƒÙ… ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ù…Ø³Ø±Ø­ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©</h1>
    <button id="btnStart">Ø§Ø¨Ø¯Ø£</button>
    <div id="chooser">
      <div class="cardMode" id="modeNormal"><div class="badge">3D</div><h3>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ</h3><p>ÙƒÙ„ Ø£Ø¯ÙˆØ§ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ© + Ø­Ø±ÙƒØ© Ø§Ù„Ø¬ÙˆØ§Ù„.</p></div>
      <div class="cardMode" id="modeVR"><div class="badge">VR</div><h3>Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</h3><p>Ø¯Ø¹Ù… Meta Quest Ø¹Ø¨Ø± WebXR.</p></div>
      <div class="cardMode" id="modeAR"><div class="badge">AR</div><h3>Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø²</h3><p>WebXR Ø¥Ù† Ø¯ÙØ¹Ù…ØŒ ÙˆØ¥Ù„Ø§ AR-Lite Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.</p></div>
    </div>
    <div id="arHint" style="display:none;margin-top:8px;color:#ffd966;font-size:13px">AR Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… â€” Ø³ÙŠØ¹Ù…Ù„ AR-Lite Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.</div>
  </div>

  <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
  <div id="loader"><div class="spinner"></div></div>

  <!-- Ø§Ù„Ù…Ø´Ù‡Ø¯ (Ù†ÙØ³ Ø§Ù„Ø£Ø³Ø§Ø³) -->
  <a-scene
    id="scene"
    embedded
    renderer="alpha:true; antialias:true; precision:mediump; colorManagement:true; physicallyCorrectLights:true"
    xr-mode-ui="enabled: true"
    webxr="optionalFeatures: hit-test,local-floor,bounded-floor,anchors,dom-overlay; overlayElement: #uiLayer">

    <!-- Ø£Ø±Ø¶ÙŠØ© ÙˆØ¬Ø¯Ø±Ø§Ù† Ø§ÙØªØ±Ø§Ø¶ÙŠØ© -->
    <a-plane id="ground" rotation="-90 0 0" width="60" height="60" color="#2d2d2d" class="clickable"></a-plane>
    <a-box position="0 3 -15" width="30" height="6" depth="0.1" color="#333" class="clickable"></a-box>
    <a-box position="0 3  15" width="30" height="6" depth="0.1" color="#333" class="clickable"></a-box>
    <a-box position="-15 3 0" width="0.1" height="6" depth="30" color="#333" class="clickable"></a-box>
    <a-box position="15 3 0"  width="0.1" height="6" depth="30" color="#333" class="clickable"></a-box>
    <a-plane rotation="90 0 0" position="0 6 0" width="30" height="30" color="#222" class="clickable"></a-plane>

    <!-- Ø¥Ø¶Ø§Ø¡Ø© -->
    <a-entity light="type:ambient; intensity:0.75"></a-entity>
    <a-entity light="type:directional; intensity:0.9; color:#fff" position="-1 3 2"></a-entity>
    <a-entity light="type:point; intensity:0.9; color:#ffd966" position="0 3 0"></a-entity>

    <!-- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ø±ÙŠØ¬ -->
    <a-entity id="rig" position="0 1.6 6" rotation="0 0 0">
      <a-entity id="cam" camera look-controls="touchEnabled:true; mouseEnabled:true" wasd-controls="acceleration:28"></a-entity>
    </a-entity>

    <!-- Ø±Ø§ÙŠÙƒØ§Ø³ØªØ± -->
    <a-entity id="ray" cursor="rayOrigin:mouse" raycaster="objects:.clickable,.placed"></a-entity>
  </a-scene>

  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø£ØµÙ„ÙŠØ© -->
  <div id="uiLayer">
    <button id="btnOpen">â‰¡</button>
    <aside id="sidebar" class="hidden">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="color:#d4af37;font-weight:900">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
        <button class="btn-ghost" id="btnClose">âœ•</button>
      </div>

      <h2>ğŸ“¦ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ø¯Ù„Ø©</h2>
      <div id="library" class="library"></div>

      <h2>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø®Ø§Ø±Ø¬ÙŠ</h2>
      <input id="customName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ±">
      <input id="customURL" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (.glb)">
      <div style="margin-top:6px"><button class="btn" id="btnAddCustom">Ø¥Ø¶Ø§ÙØ©</button></div>

      <h2>ğŸ§© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø©</h2>
      <select id="placedList" size="6" style="width:100%"></select>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button class="btn-ghost" id="btnDelete">ğŸ—‘ Ø­Ø°Ù</button>
        <button class="btn-ghost" id="btnReset">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
      </div>

      <h2>âœ…âŒ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ù„Ø©</h2>
      <select id="evidenceSel">
        <option value="none" selected>â€” Ø¨Ø¯ÙˆÙ† ØªÙ‚ÙŠÙŠÙ… â€”</option>
        <option value="true">âœ”ï¸ ØµØ­ÙŠØ­</option>
        <option value="false">âŒ Ø®Ø§Ø·Ø¦</option>
      </select>
      <div style="margin-top:6px"><button class="btn" id="btnApplyEvidence">ØªØ·Ø¨ÙŠÙ‚</button></div>

      <h2>âš™ï¸ Ø§Ù„ØªØ­ÙƒÙ…</h2>
      <select id="controlMode">
        <option value="object">Ø§Ù„ØªØ­ÙƒÙ…: Ø§Ù„Ø¹Ù†ØµØ±</option>
        <option value="camera">Ø§Ù„ØªØ­ÙƒÙ…: Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</option>
      </select>
      <div style="margin-top:6px">
        Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø±ÙƒØ©:
        <select id="stepSel">
          <option value="0.05">0.05</option>
          <option value="0.1" selected>0.1</option>
          <option value="0.25">0.25</option>
          <option value="0.5">0.5</option>
        </select>
      </div>
    </aside>
  </div>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø£ØµÙ„ÙŠØ© -->
  <div class="dynamic-controls" id="controls">
    <div><button class="ctrl-btn" data-act="up">â¬†ï¸</button> <button class="ctrl-btn" data-act="down">â¬‡ï¸</button></div>
    <div><button class="ctrl-btn" data-act="left">â¬…ï¸</button> <button class="ctrl-btn" data-act="right">â¡ï¸</button></div>
    <div><button class="ctrl-btn" data-act="zoomIn">ğŸ”¼</button> <button class="ctrl-btn" data-act="zoomOut">ğŸ”½</button></div>
    <div><button class="ctrl-btn" data-act="rotL">âŸ²</button> <button class="ctrl-btn" data-act="rotR">âŸ³</button></div>
  </div>
  <div class="camera-controls" id="cameraPanel">
    <button class="cam-btn" data-cam="up">â¬†ï¸</button>
    <button class="cam-btn" data-cam="down">â¬‡ï¸</button>
    <button class="cam-btn" data-cam="left">â¬…ï¸</button>
    <button class="cam-btn" data-cam="right">â¡ï¸</button>
    <button class="cam-btn" data-cam="fwd">ğŸ”¼</button>
    <button class="cam-btn" data-cam="back">ğŸ”½</button>
    <button class="cam-btn" data-cam="yawL">âŸ²</button>
    <button class="cam-btn" data-cam="yawR">âŸ³</button>
  </div>

  <!-- D-ID -->
  <div id="didWrap">
    <script type="module"
      src="https://agent.d-id.com/v2/index.js"
      data-mode="fabio"
      data-client-key="Z29vZ2xlLW9hdXRoMnwxMTYxMTA1NDg0NzE4MjIxMjEzNzU6ZW1hOGpRYnRPcnJOSENjeU9nTUF3"
      data-agent-id="v2_agt_JPqY3TqZ"
      data-name="did-agent"
      data-monitor="true"
      data-orientation="horizontal"
      data-position="right"></script>
  </div>

  <!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª + Toast -->
  <div id="noteModal"><div class="noteCard">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <strong style="color:#d4af37">Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ÙÙ‚Ø·)</strong>
      <button class="btn-ghost" id="noteCancel">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    <textarea id="noteText" rows="5" style="width:100%;padding:8px;border-radius:10px;background:#0c1116;color:#fff" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..."></textarea>
    <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn" id="noteSave">Ø­ÙØ¸</button></div>
  </div></div>
  <div class="toast" id="toast"></div>
</div>

<script>
/* ========== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ========== */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
function toast(t){ const el=$('#toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',1400); }
function showLoader(v){ $('#loader').style.display=v?'grid':'none'; }

/* ========== Ø²Ù…Ù† HUD ========== */
setInterval(()=>{ const d=new Date(); const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0'); $('#time').textContent=`${hh}:${mm}`; }, 1000);

/* ========== Ø´Ø§Ø´Ø© Ø§Ø¨Ø¯Ø£ ========== */
let currentMode=null;
$('#btnStart').addEventListener('click', async ()=>{
  $('#btnStart').style.display='none'; $('#chooser').style.display='flex';

  // ÙØ­Øµ Ø¯Ø¹Ù… AR Ø­Ù‚ÙŠÙ‚ÙŠ
  try{
    const ok = !!(navigator.xr && await navigator.xr.isSessionSupported('immersive-ar'));
    $('#arHint').style.display = ok ? 'none' : 'block';
  }catch{ $('#arHint').style.display='block'; }
});

/* ========== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ ========== */
const scene = $('#scene');
$('#modeNormal').onclick=()=>{
  currentMode='normal'; $('#gate').style.display='none';
  enableMotionIfAllowed();
  toast('Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù…ÙØ¹Ù‘Ù„');
};
$('#modeVR').onclick=()=>{
  currentMode='vr'; $('#gate').style.display='none';
  disableMotion(); setTimeout(()=> scene.enterVR?.(), 120);
};
$('#modeAR').onclick= async ()=>{
  currentMode='ar'; $('#gate').style.display='none';
  disableMotion();
  // Ù…Ø­Ø§ÙˆÙ„Ø© AR Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø£ÙˆÙ„Ù‹Ø§
  let immersiveARSupported=false;
  try{ immersiveARSupported=!!(navigator.xr && await navigator.xr.isSessionSupported('immersive-ar')); }catch(e){}
  if(immersiveARSupported){
    try{ setTimeout(()=> scene.enterAR?.(), 80); toast('Ø¬Ø§Ø± ØªÙØ¹ÙŠÙ„ AR Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ...'); return; }catch(e){}
  }
  // Fallback: AR-Lite (ÙƒØ§Ù…ÙŠØ±Ø§ Ø®Ù„ÙÙŠØ© + Ù…Ø´Ù‡Ø¯ Ø´ÙØ§Ù)
  toast('ØªÙ… ØªÙØ¹ÙŠÙ„ AR-Lite (Ø®Ù„ÙÙŠØ© ÙƒØ§Ù…ÙŠØ±Ø§)');
  startARLite();
};

/* ========== AR-Lite ========== */
let arStream=null;
async function startARLite(){
  try{
    const vid = $('#arVideoBg');
    arStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    vid.srcObject = arStream; vid.style.display='block';
    // Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø´ÙØ§Ù ÙÙˆÙ‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    const canvas = scene.canvas;
    if(canvas){ canvas.style.background='transparent'; canvas.style.zIndex=1; }
    // Ù„Ù…Ø³ Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¹Ù„Ù‰ "Ø£Ø±Ø¶ Ø§ÙØªØ±Ø§Ø¶ÙŠØ©" (a-plane id=ground)
    setupTapPlacement();
  }catch(e){ alert('ÙØ´Ù„ ØªØ´ØºÙŠÙ„ ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©'); }
}
function stopARLite(){
  const vid=$('#arVideoBg');
  if(arStream){ arStream.getTracks().forEach(t=>t.stop()); arStream=null; }
  vid.srcObject=null; vid.style.display='none';
}

/* ========== ÙˆØ§Ø¬Ù‡Ø© Ø£ØµÙ„ÙŠØ© (ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚) ========== */
$('#btnOpen').onclick=()=> $('#sidebar').classList.remove('hidden');
$('#btnClose').onclick=()=> $('#sidebar').classList.add('hidden');

/* ========== Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£Ø¯Ù„Ø© + Ø¥Ø¶Ø§ÙØ© Ø®Ø§Ø±Ø¬ÙŠ ========== */
const library = [
  {name:'ØºØ±ÙØ©', url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/room.glb'},
  {name:'Ø³Ø±ÙŠØ±', url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/bed.glb'},
  {name:'Ø¨Ù‚Ø¹Ø© Ø¯Ù…', url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/blood.glb'},
  {name:'Ø³Ù„Ø§Ø­', url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/gun1.glb'}
];
const libEl=$('#library');
function renderLibrary(){
  libEl.innerHTML='';
  library.forEach((m,i)=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<div style="font-weight:800">${m.name}</div><button class="btn">ÙˆØ¶Ø¹</button>`;
    card.querySelector('button').onclick=()=> placeModel(i);
    libEl.appendChild(card);
  });
}
renderLibrary();
$('#btnAddCustom').onclick=()=>{
  const n=$('#customName').value.trim();
  const u=$('#customURL').value.trim();
  if(!n||!u){ toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ø§Ø¨Ø·'); return; }
  library.push({name:n,url:u}); renderLibrary(); toast('âœ… Ø£ÙØ¶ÙŠÙ Ù„Ù„Ù…ÙƒØªØ¨Ø©');
};

/* ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± ========== */
let placed=[]; let selected=null;
const placedList=$('#placedList'); const evidenceSel=$('#evidenceSel');

function selectById(id){
  const rec=placed.find(p=>p.id===id); if(!rec) return;
  selected=rec.el; placedList.value=id;
  evidenceSel.value=selected.getAttribute('data-valid')||'none';
}
placedList.onchange=e=>selectById(e.target.value);

function placeModel(i, posOverride=null){
  const m=library[i]; if(!m) return;
  const id='ent-'+Date.now();
  const ent=document.createElement('a-entity');
  ent.setAttribute('id',id);
  ent.setAttribute('gltf-model',m.url);
  ent.setAttribute('position', posOverride ? posOverride : '0 0 -2.4');
  ent.setAttribute('rotation','0 180 0');
  ent.classList.add('placed','clickable');
  ent.setAttribute('data-valid','none'); ent.setAttribute('data-scored','no');

  showLoader(true);
  ent.addEventListener('model-error',()=>{ showLoader(false); toast('âŒ Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù„Ù GLB ØªØ§Ù„Ù'); ent.remove(); });
  ent.addEventListener('model-loaded',e=>{
    showLoader(false);
    const THREE=AFRAME.THREE; const root=e.detail.model||ent.getObject3D('mesh'); if(!root) return;
    const bbox=new THREE.Box3().setFromObject(root); const size=bbox.getSize(new THREE.Vector3());
    const s=Math.min(0.35, 1/(Math.max(size.x,size.y,size.z)||1)); ent.setAttribute('scale',`${s} ${s} ${s}`);
    // Ø«Ø¨Ù‘Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶
    const minY=bbox.min.y; const p=ent.getAttribute('position'); p.y=Math.max(0.02, p.y - (s*minY)); ent.setAttribute('position',p);
  });

  scene.appendChild(ent);
  placed.push({id,name:m.name,el:ent});
  const opt=document.createElement('option'); opt.value=id; opt.textContent=m.name; placedList.appendChild(opt);
  selectById(id); toast('ÙˆÙØ¶Ø¹ '+m.name);
}

/* Ø¥Ø³Ù‚Ø§Ø· Ø¨Ø§Ù„Ø¹Ø§Ù„Ù… (AR-Lite): Ù„Ù…Ø³ Ø§Ù„Ø´Ø§Ø´Ø© â†’ Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¶Ø¹ Ø¹Ù„Ù‰ plane ground */
function setupTapPlacement(){
  const ground = document.querySelector('#ground');
  const sceneEl = document.querySelector('a-scene');
  sceneEl.addEventListener('click', (evt)=>{
    if(currentMode!=='ar') return;
    // Ø´Ø¹Ø§Ø¹ Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„Ù„Ù…Ø³
    const mouse = new AFRAME.THREE.Vector2(
      (evt.clientX / window.innerWidth) * 2 - 1,
      -(evt.clientY / window.innerHeight) * 2 + 1
    );
    const camera = sceneEl.camera;
    const raycaster = new AFRAME.THREE.Raycaster();
    raycaster.setFromCamera(mouse, camera);
    const plane = ground.getObject3D('mesh'); if(!plane) return;
    const intersects = raycaster.intersectObject(plane);
    if(intersects && intersects[0]){
      const pt = intersects[0].point;
      // Ø¶Ø¹ Ø£ÙˆÙ„ Ø¹Ù†ØµØ± Ø¨Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙƒÙ…Ø«Ø§Ù„ Ø³Ø±ÙŠØ¹ØŒ Ø£Ùˆ Ø§ÙØªØ­ Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙƒØ§Ù„Ù…Ø¹ØªØ§Ø¯
      placeModel(0, `${pt.x} ${pt.y} ${pt.z}`);
      toast('ğŸ“ ØªÙ… Ø¥Ø³Ù‚Ø§Ø· Ø¹Ù†ØµØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶');
    }
  });
}

/* ØªÙ‚ÙŠÙŠÙ… / Ø­Ø°Ù / Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· */
$('#btnApplyEvidence').onclick=()=>{
  if(!selected){ toast('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§'); return; }
  const v=evidenceSel.value; selected.setAttribute('data-valid',v);
  toast('ØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: '+(v==='true'?'âœ”ï¸ ØµØ­ÙŠØ­':v==='false'?'âŒ Ø®Ø§Ø·Ø¦':'Ø¨Ø¯ÙˆÙ†'));
};
$('#btnDelete').onclick=()=>{
  if(!selected){ toast('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§'); return; }
  const id=placedList.value; selected.remove();
  placed = placed.filter(p=>p.id!==id);
  [...placedList.options].forEach(o=>{if(o.value===id)o.remove();});
  selected=null; evidenceSel.value='none'; toast('ğŸ—‘ Ø­ÙØ°Ù');
};
$('#btnReset').onclick=()=>{
  $$('.placed').forEach(e=>e.remove());
  placed=[]; placedList.innerHTML='';
  if(currentMode==='ar') stopARLite();
  toast('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·');
};

/* ========== ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø§Ù„Ø¹Ù†ØµØ± (ÙƒÙ…Ø§Ù‡ÙŠ) ========== */
const controlModeSel=$('#controlMode'); let controlMode=controlModeSel.value;
controlModeSel.onchange=()=> controlMode=controlModeSel.value;
function step(){ return parseFloat($('#stepSel').value)||0.1; }
const rig=$('#rig');

$$('#controls .ctrl-btn').forEach(b=>{
  b.addEventListener('click',()=>{
    if(!selected){ toast('Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§'); return; }
    const act=b.dataset.act;
    const pos=selected.getAttribute('position')||{x:0,y:0,z:0};
    const rot=selected.getAttribute('rotation')||{x:0,y:0,z:0};
    const s=step();
    if(act==='up') selected.setAttribute('position',{x:pos.x,y:pos.y+s,z:pos.z});
    if(act==='down') selected.setAttribute('position',{x:pos.x,y:Math.max(0,pos.y-s),z:pos.z});
    if(act==='left') selected.setAttribute('position',{x:pos.x-s,y:pos.y,z:pos.z});
    if(act==='right') selected.setAttribute('position',{x:pos.x+s,y:pos.y,z:pos.z});
    if(act==='zoomIn') selected.setAttribute('position',{x:pos.x,y:pos.y,z:pos.z- s*2});
    if(act==='zoomOut')selected.setAttribute('position',{x:pos.x,y:pos.y,z:pos.z+ s*2});
    if(act==='rotL') selected.setAttribute('rotation'){x:rot.x,y:rot.y-10,z:rot.z};
    if(act==='rotR') selected.setAttribute('rotation'){x:rot.x,y:rot.y+10,z:rot.z};
  });
});
$$('#cameraPanel .cam-btn').forEach(b=>{
  b.addEventListener('click',()=>{
    const pos=rig.getAttribute('position')||{x:0,y:0,z:0};
    const rot=rig.getAttribute('rotation')||{x:0,y:0,z:0};
    const s=step()*3; const a=b.dataset.cam;
    if(a==='up') rig.setAttribute('position',{x:pos.x,y:pos.y+s,z:pos.z});
    if(a==='down') rig.setAttribute('position',{x:pos.x,y:Math.max(0,pos.y-s),z:pos.z});
    if(a==='left') rig.setAttribute('position',{x:pos.x-s,y:pos.y,z:pos.z});
    if(a==='right')rig.setAttribute('position',{x:pos.x+s,y:pos.y,z:pos.z});
    if(a==='fwd') rig.setAttribute('position',{x:pos.x,y:pos.y,z:pos.z- s});
    if(a==='back')rig.setAttribute('position',{x:pos.x,y:pos.y,z:pos.z+ s});
    if(a==='yawL') rig.setAttribute('rotation',{x:rot.x,y:rot.y-12,z:rot.z});
    if(a==='yawR') rig.setAttribute('rotation',{x:rot.x,y:rot.y+12,z:rot.z});
  });
});

/* ========== Ø³Ø­Ø¨ Ø§Ù„Ù…Ø§ÙˆØ³/Ø§Ù„Ù„Ù…Ø³ ========== */
let isDragging=false, lastX=0, lastY=0;
window.addEventListener('mousedown', e=>{ isDragging=true; lastX=e.clientX; lastY=e.clientY; }, {passive:true});
window.addEventListener('mouseup', ()=> isDragging=false);
window.addEventListener('mousemove', e=>{
  if(!isDragging) return;
  const dx=e.clientX-lastX, dy=e.clientY-lastY; lastX=e.clientX; lastY=e.clientY;
  if(controlMode==='object' && selected){
    selected.setAttribute('rotation',{x:0,y:(selected.getAttribute('rotation')?.y||0)-dx*0.3,z:0});
    if(Math.abs(dy)>2){ const p=selected.getAttribute('position')||{x:0,y:0,z:0}; selected.setAttribute('position',{x:p.x,y:Math.max(0,p.y - dy*0.01),z:p.z}); }
  }else{
    const rot=rig.getAttribute('rotation')||{x:0,y:0,z:0};
    rig.setAttribute('rotation',{x:Math.max(-60,Math.min(60, rot.x - dy*0.15)), y:rot.y - dx*0.2, z:rot.z});
  }
});
scene.addEventListener('wheel', e=>{
  const delta=Math.sign(e.deltaY);
  if(controlMode==='object' && selected){
    const p=selected.getAttribute('position')||{x:0,y:0,z:0};
    selected.setAttribute('position',{x:p.x,y:p.y,z:p.z + delta*0.6});
  }else{
    const p=rig.getAttribute('position')||{x:0,y:0,z:0};
    rig.setAttribute('position',{x:p.x,y:p.y,z:p.z + delta*0.8});
  }
}, {passive:true});

/* ========== Ø­Ø±ÙƒØ© Ø§Ù„Ø¬ÙˆØ§Ù„ (Device Orientation) Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙÙ‚Ø· ========== */
let motionOn=false;
function enableMotionIfAllowed(){
  if(motionOn) return;
  // Ø¹Ù„Ù‰ iOS ÙŠØ¬Ø¨ Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ© ØµØ±ÙŠØ­Ø©
  if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
    $('#motionTip').style.display='block';
  }else{
    bindDeviceOrientation(); // Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ ÙˆÙ…ØªØµÙØ­Ø§Øª ØªØ¯Ø¹Ù… Ù…Ø¨Ø§Ø´Ø±Ø©
  }
}
$('#btnMotion').onclick=async ()=>{
  try{
    const perm = await DeviceOrientationEvent.requestPermission();
    if(perm==='granted'){ bindDeviceOrientation(); $('#motionTip').style.display='none'; toast('Ø­Ø±ÙƒØ© Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…ÙØ¹Ù‘Ù„Ø©'); }
    else toast('ØªÙ… Ø±ÙØ¶ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø±ÙƒØ©');
  }catch{ bindDeviceOrientation(); $('#motionTip').style.display='none'; }
};
let lastAlpha=null, lastBeta=null;
function bindDeviceOrientation(){
  if(motionOn) return; motionOn=true;
  window.addEventListener('deviceorientation', e=>{
    if(currentMode!=='normal') return;
    const a=e.alpha??0, b=e.beta??0, g=e.gamma??0;
    // ØªÙ†Ø¹ÙŠÙ… Ø¨Ø³ÙŠØ·
    const lerp=(s,e,t)=> s+(e-s)*t;
    lastAlpha = lastAlpha===null? a : lerp(lastAlpha, a, 0.1);
    lastBeta  = lastBeta===null?  b : lerp(lastBeta , b, 0.1);
    const yaw = lastAlpha;      // Ø¯ÙˆØ±Ø§Ù† Ø­ÙˆÙ„ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ
    const pitch = lastBeta/3;   // Ø¥Ù…Ø§Ù„Ø© Ù„Ø·ÙŠÙØ©
    const rot=rig.getAttribute('rotation')||{x:0,y:0,z:0};
    rig.setAttribute('rotation',{x:pitch, y:yaw, z:rot.z});
  }, true);
}
function disableMotion(){ motionOn=false; $('#motionTip').style.display='none'; }

/* ========== Ø­ÙØ¸/Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ========= */
function saveScene(){
  const data=[]; document.querySelectorAll('.placed').forEach(ent=>{
    data.push({ model: ent.getAttribute('gltf-model'), position: ent.getAttribute('position'), rotation: ent.getAttribute('rotation'), scale: ent.getAttribute('scale') });
  });
  localStorage.setItem('crimeSceneData', JSON.stringify(data));
}
function loadScene(){
  const saved=localStorage.getItem('crimeSceneData'); if(!saved) return;
  try{
    const arr=JSON.parse(saved);
    arr.forEach((item,idx)=>{
      const id='ent-'+Date.now()+'-'+idx;
      const ent=document.createElement('a-entity');
      ent.setAttribute('id',id);
      ent.setAttribute('gltf-model',item.model);
      ent.setAttribute('position',item.position);
      ent.setAttribute('rotation',item.rotation);
      ent.setAttribute('scale',item.scale);
      ent.classList.add('placed','clickable'); ent.setAttribute('data-valid','none'); ent.setAttribute('data-scored','no');
      scene.appendChild(ent);
      const name=(item.model||'').split('/').pop(); placed.push({id,name,el:ent});
      const opt=document.createElement('option'); opt.value=id; opt.textContent=name; placedList.appendChild(opt);
      ent.addEventListener('click', ()=> selectById(id));
    });
    toast('âœ… ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚');
  }catch(e){}
}
window.addEventListener('beforeunload', saveScene);
window.addEventListener('load', loadScene);

/* ========== Ø¶Ø¨Ø· Ø§Ù„Ù‚ÙŠØ§Ø³ ========== */
function resizeScene(){ scene.style.height=window.innerHeight+'px'; scene.style.width=window.innerWidth+'px'; }
window.addEventListener('resize', resizeScene);
window.addEventListener('orientationchange', ()=> setTimeout(resizeScene, 200));
resizeScene();
</script>
</body>
</html>
