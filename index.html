<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Launcher — Royal Stable + AR/VR</title>

<!-- A-Frame فقط لقسم الـ AR داخل هذا الملف -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

<style>
:root{--gold:#d4af37;--gold2:#b78f2a;--dark:#0b0f13;--glass:#0b0f13cc}
*{box-sizing:border-box}
html,body{margin:0;height:100%;overflow:hidden;background:var(--dark);color:#fff;font-family:"Tajawal",system-ui,Arial}

/* شاشة الاختيار */
#gate{
  position:fixed;inset:0;z-index:10;display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:radial-gradient(720px 460px at 50% 40%,rgba(212,175,55,.14),rgba(0,0,0,.86));padding:18px;text-align:center
}
h1{margin:0 0 10px;color:var(--gold)}
#chooser{display:flex;gap:14px;flex-wrap:wrap;justify-content:center}
.card{
  position:relative;overflow:hidden;border-radius:18px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);
  min-width:240px;max-width:300px;padding:16px;cursor:pointer;transition:transform .18s ease, box-shadow .18s ease, opacity .25s ease;
  box-shadow:inset 0 0 16px rgba(212,175,55,.12)
}
.card:hover{transform:translateY(-4px);box-shadow:0 14px 32px rgba(212,175,55,.25)}
.card h3{margin:0 0 6px;color:var(--gold)}
.card p{margin:0;color:#dde6ff;opacity:.9;font-size:14px}
.badge{position:absolute;top:10px;left:10px;background:linear-gradient(90deg,var(--gold),var(--gold2));color:#000;font-weight:900;padding:6px 10px;border-radius:999px;font-size:12px}

/* AR UI */
#arShell{position:fixed;inset:0;display:none;z-index:0}
#arVideoBg{
  position:fixed;inset:0;object-fit:cover;width:100vw;height:100vh;display:none;z-index:0;background:#000
}
#arScene{position:relative;width:100%;height:100%;z-index:1}
#arUI{position:fixed;inset:0;z-index:2;pointer-events:none}
#arUI .ui{pointer-events:auto}
#arSidebar{
  position:absolute;top:0;right:0;width:360px;max-width:92vw;height:100%;padding:12px;overflow:auto;
  background:var(--glass);backdrop-filter:blur(12px);border-left:1px solid rgba(255,255,255,.12)
}
#arSidebar h2{color:var(--gold);margin:10px 0 6px}
.btn{border:none;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:800;background:linear-gradient(90deg,var(--gold),var(--gold2));color:#000}
.btn-ghost{border:1px solid rgba(255,255,255,.2);background:transparent;color:#e0e6f2;border-radius:10px;padding:7px 10px;cursor:pointer}
input{width:100%;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0c1116;color:#fff}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}
.cardItem{background:rgba(255,255,255,.06);border-radius:12px;padding:8px;text-align:center;box-shadow:inset 0 0 12px rgba(212,175,55,.12)}
.cardItem .btn{width:100%;margin-top:6px}

#arTopBar{
  position:absolute;top:12px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:12px;font-weight:800
}
#toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);padding:10px 14px;border-radius:10px;display:none;z-index:999}

@media (max-width:768px){
  #arSidebar{width:92vw}
}
</style>
</head>
<body>

<!-- شاشة اختيار الوضع (فقط عند البداية) -->
<section id="gate">
  <h1>اختر وضع العرض</h1>
  <div id="chooser">
    <div class="card" id="choose3d"><div class="badge">3D</div><h3>الوضع العادي</h3><p>يفتح ملفك الأصلي <b>3d.html</b> كما هو تمامًا.</p></div>
    <div class="card" id="chooseVR"><div class="badge">VR</div><h3>الواقع الافتراضي</h3><p>يفتح <b>3d.html</b> — ادخل VR من داخله.</p></div>
    <div class="card" id="chooseAR"><div class="badge">AR</div><h3>الواقع المعزز</h3><p>كاميرا حقيقية + إضافة عناصر في الواقع.</p></div>
  </div>
</section>

<!-- غلاف الـ AR (كاميرا + مشهد) -->
<section id="arShell">
  <video id="arVideoBg" autoplay playsinline muted></video>

  <a-scene id="arScene"
    embedded
    renderer="alpha:true; antialias:true; precision:high; colorManagement:true; physicallyCorrectLights:true; toneMapping:ACESFilmic; exposure:1.1">
    <!-- أرضية خفية للرايكاست -->
    <a-plane id="hitGround" rotation="-90 0 0" position="0 0 0" width="300" height="300" visible="false" class="clickable"></a-plane>
    <!-- إضاءة ثابتة (حل سواد الخامات) -->
    <a-entity id="amb" light="type:ambient; intensity:0.95; color:#ffffff"></a-entity>
    <a-entity id="dir" light="type:directional; intensity:0.85; color:#ffffff" position="-1 3 2"></a-entity>
    <a-entity id="pt"  light="type:point; intensity:0.85; color:#ffd966" position="0 3 0"></a-entity>

    <a-entity id="rig" position="0 1.6 2"><a-entity id="cam" camera look-controls="touchEnabled:true; mouseEnabled:true"></a-entity></a-entity>
    <a-entity id="ray" cursor="rayOrigin:mouse" raycaster="objects:.clickable,.placed"></a-entity>
  </a-scene>

  <div id="arUI">
    <div id="arTopBar" class="ui">AR نشط — المس الأرض لإسقاط عنصر</div>
    <aside id="arSidebar" class="ui">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h2>📦 مكتبة العناصر</h2>
        <button id="btnBackHome" class="btn-ghost">رجوع</button>
      </div>

      <div id="lib" class="grid"></div>

      <h2>➕ إضافة عنصر خارجي</h2>
      <input id="nameIn" placeholder="اسم العنصر">
      <input id="urlIn" placeholder="رابط GLB">
      <div style="margin-top:6px"><button id="btnAdd" class="btn">إضافة</button></div>

      <h2>🧩 العناصر الموضوعة</h2>
      <select id="placedList" size="6" style="width:100%"></select>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="btnDel" class="btn-ghost">🗑 حذف</button>
        <button id="btnReset" class="btn-ghost">🔄 إعادة ضبط</button>
      </div>

      <h2>⚙️ تحكم سريع بالعنصر المختار</h2>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">
        <button class="btn-ghost obj" data-act="scaleUp">تكبير</button>
        <button class="btn-ghost obj" data-act="scaleDown">تصغير</button>
        <button class="btn-ghost obj" data-act="tiltL">ميل ↺</button>
        <button class="btn-ghost obj" data-act="tiltR">ميل ↻</button>
        <button class="btn-ghost obj" data-act="up">⬆️</button>
        <button class="btn-ghost obj" data-act="down">⬇️</button>
        <button class="btn-ghost obj" data-act="left">⬅️</button>
        <button class="btn-ghost obj" data-act="right">➡️</button>
        <button class="btn-ghost obj" data-act="zoomIn">🔼 قرب</button>
        <button class="btn-ghost obj" data-act="zoomOut">🔽 بعد</button>
        <button class="btn-ghost obj" data-act="rotL">⟲ دوران</button>
        <button class="btn-ghost obj" data-act="rotR">⟳ دوران</button>
      </div>
    </aside>
  </div>

  <div id="toast"></div>
</section>

<script>
/* ===== شاشة الاختيار (فقط عند البداية) ===== */
const g = (id)=>document.getElementById(id);
g('choose3d').onclick = ()=> location.href = '3d.html';
g('chooseVR').onclick  = ()=> location.href = '3d.html#vr'; // لا نعدل الأصل — ادخل VR من داخله
g('chooseAR').onclick  = ()=> { g('gate').style.display='none'; startAR(); };

/* ===== AR داخل هذا الملف (كاميرا + عناصر) ===== */
const scene = g('arScene'), rig=g('rig'), hitGround=g('hitGround');
const toast=(t)=>{ const el=g('toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',1400); };

let arStream=null, placed=[], selected=null;
const placedList=g('placedList');

const library = [
  {name:'غرفة كاملة', url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/room.glb'},
  {name:'سرير',       url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/bed.glb'},
  {name:'بقعة دم',    url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/blood.glb'},
  {name:'سلاح',       url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/gun1.glb'},
  {name:'سكين',       url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/knife.glb'},
  {name:'سيف',        url:'https://dns3uae-glitch.github.io/crime-book-ai/assets/sword.glb'}
];

function renderLib(){
  const c=g('lib'); c.innerHTML='';
  library.forEach((m,i)=>{
    const d=document.createElement('div'); d.className='cardItem';
    d.innerHTML=`<div style="font-weight:800">${m.name}</div><button class="btn">وضع</button>`;
    d.querySelector('button').onclick=(e)=>{ e.preventDefault(); placeModel(i); };
    c.appendChild(d);
  });
}
renderLib();

g('btnAdd').onclick=()=>{
  const n=g('nameIn').value.trim(), u=g('urlIn').value.trim();
  if(!n||!u){ toast('أدخل الاسم والرابط'); return; }
  library.push({name:n,url:u}); renderLib(); toast('✅ أُضيف');
};

g('btnBackHome').onclick=()=>{
  stopAR();
  // رجوع لشاشة الاختيار
  g('gate').style.display='flex';
};

async function startAR(){
  g('arShell').style.display='block';
  try{
    // تشغيل كاميرا الخلفية
    const vid=g('arVideoBg');
    arStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    vid.srcObject=arStream; vid.style.display='block';
    // شفافية المشهد فوق الفيديو
    const canvas=scene.canvas; if(canvas){ canvas.style.background='transparent'; canvas.style.zIndex=1; }
    setupARInteractions();
    toast('AR قيد التشغيل — اختر عنصرًا ثم المس الأرض لوضعه');
  }catch(e){
    alert('تعذّر تشغيل الكاميرا.'); g('arShell').style.display='none'; g('gate').style.display='flex';
  }
}
function stopAR(){
  const vid=g('arVideoBg');
  if(arStream){ arStream.getTracks().forEach(t=>t.stop()); arStream=null; }
  vid.srcObject=null; vid.style.display='none';
  // إزالة العناصر الموضوعة في جلسة AR الحالية
  document.querySelectorAll('.placed').forEach(el=>el.remove());
  placed=[]; placedList.innerHTML='';
  g('arShell').style.display='none';
}

function placeModel(i, posOverride=null){
  const m=library[i]; if(!m) return;
  const id='ent-'+Date.now(); const ent=document.createElement('a-entity');
  ent.setAttribute('id',id);
  ent.setAttribute('gltf-model',m.url);
  ent.setAttribute('position', posOverride ? posOverride : '0 0 -1.2');
  ent.setAttribute('rotation','0 180 0');
  ent.classList.add('placed','clickable');

  // تأمين الإضاءة لتفادي السواد
  ent.addEventListener('model-loaded', e=>{
    const THREE=AFRAME.THREE; const root=e.detail.model||ent.getObject3D('mesh'); if(!root) return;
    root.traverse(o=>{ if(o.isMesh){ o.material.side=THREE.FrontSide; if('metalness' in o.material){ o.material.needsUpdate=true; } } });
    // مقياس مناسب
    const bbox=new THREE.Box3().setFromObject(root); const size=bbox.getSize(new THREE.Vector3());
    const s=Math.min(0.35, 1/(Math.max(size.x,size.y,size.z)||1)); ent.setAttribute('scale',`${s} ${s} ${s}`);
    const minY=bbox.min.y; const p=ent.getAttribute('position'); p.y=Math.max(0.02, p.y - (s*minY)); ent.setAttribute('position',p);
  });

  scene.appendChild(ent);
  placed.push({id,name:m.name,el:ent});
  const opt=document.createElement('option'); opt.value=id; opt.textContent=m.name; placedList.appendChild(opt);
  selectById(id); toast('وُضع '+m.name);
  ent.addEventListener('click',()=>selectById(id));
}
function selectById(id){
  const rec=placed.find(p=>p.id===id); if(!rec) return;
  selected=rec.el; placedList.value=id;
}
placedList.onchange=(e)=>selectById(e.target.value);

function setupARInteractions(){
  // لمس لإسقاط على hitGround
  scene.addEventListener('click',(evt)=>{
    const mouse=new AFRAME.THREE.Vector2((evt.clientX/window.innerWidth)*2-1, -(evt.clientY/window.innerHeight)*2+1);
    const camera=scene.camera; const ray=new AFRAME.THREE.Raycaster();
    ray.setFromCamera(mouse, camera);
    const plane=hitGround.getObject3D('mesh'); if(!plane) return;
    const hit=ray.intersectObject(plane);
    if(hit && hit[0]){
      const pt=hit[0].point;
      // بشكل افتراضي ضع أول عنصر من المكتبة (تقدر تختار غيره من القائمة)
      placeModel(0, `${pt.x} ${pt.y} ${pt.z}`);
      toast('📍 تم إسقاط عنصر');
    }
  });
}

/* تحكم سريع بالعنصر في واجهة AR */
function step(){ return 0.1; }
function sstep(){ return 0.05; }
document.querySelectorAll('#arSidebar .obj').forEach(b=>{
  b.addEventListener('click', e=>{
    e.preventDefault(); if(!selected){ toast('اختر عنصرًا من القائمة أدناه'); return; }
    const act=b.dataset.act;
    const pos=selected.getAttribute('position')||{x:0,y:0,z:0};
    const rot=selected.getAttribute('rotation')||{x:0,y:0,z:0};
    const sc =selected.getAttribute('scale')||{x:1,y:1,z:1};
    if(act==='up')    selected.setAttribute('position',{x:pos.x,y:pos.y+step(),z:pos.z});
    if(act==='down')  selected.setAttribute('position',{x:pos.x,y:Math.max(0,pos.y-step()),z:pos.z});
    if(act==='left')  selected.setAttribute('position',{x:pos.x-step(),y:pos.y,z:pos.z});
    if(act==='right') selected.setAttribute('position',{x:pos.x+step(),y:pos.y,z:pos.z});
    if(act==='zoomIn')selected.setAttribute('position',{x:pos.x,y:pos.y,z:pos.z- step()*2});
    if(act==='zoomOut')selected.setAttribute('position',{x:pos.x,y:pos.y,z:pos.z+ step()*2});
    if(act==='rotL')  selected.setAttribute('rotation',{x:rot.x,y:rot.y-10,z:rot.z});
    if(act==='rotR')  selected.setAttribute('rotation',{x:rot.x,y:rot.y+10,z:rot.z});
    if(act==='scaleUp')  selected.setAttribute('scale',{x:sc.x+sstep(),y:sc.y+sstep(),z:sc.z+sstep()});
    if(act==='scaleDown')selected.setAttribute('scale',{x:Math.max(0.01,sc.x-sstep()),y:Math.max(0.01,sc.y-sstep()),z:Math.max(0.01,sc.z-sstep())});
    if(act==='tiltL') selected.setAttribute('rotation',{x:rot.x+5,y:rot.y,z:rot.z});
    if(act==='tiltR') selected.setAttribute('rotation',{x:rot.x-5,y:rot.y,z:rot.z});
  });
});

/* حذف / إعادة ضبط */
g('btnDel').onclick=()=>{
  if(!selected){ toast('اختر عنصرًا'); return; }
  const id=placedList.value; selected.remove();
  placed = placed.filter(p=>p.id!==id);
  [...placedList.options].forEach(o=>{ if(o.value===id)o.remove(); });
  selected=null; toast('🗑 حُذف');
};
g('btnReset').onclick=()=>{
  document.querySelectorAll('.placed').forEach(e=>e.remove());
  placed=[]; placedList.innerHTML='';
  toast('🔄 تمت إعادة الضبط');
};
</script>

</body>
</html>
